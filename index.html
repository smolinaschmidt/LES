<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>NYC Forestry: Custom Icons</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* --- ESTILO GENERAL --- */
    body { margin: 0; padding: 0; background-color: #FDFCF6; font-family: 'Inter', sans-serif; overflow: hidden; color: #333; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; background-color: #FDFCF6; }

    /* --- TOP BAR --- */
    #top-bar {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 8px; z-index: 20;
        background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 30px;
        backdrop-filter: blur(8px); border: 1px solid #ddd; overflow-x: auto; max-width: 95%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); scrollbar-width: none;
    }
    #top-bar::-webkit-scrollbar { display: none; }
    
    .b-btn {
        background: transparent; border: none; color: #666;
        padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 11px; font-weight: 600;
        transition: 0.2s; white-space: nowrap; font-family: 'Inter';
    }
    .b-btn:hover { color: #000; background: #f0f0f0; }
    .b-btn.active { background: #333; color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .iso-btn { background: #eee; color: #555; border: 1px solid #ddd; }
    .iso-btn:hover { background: #ddd; color: #000; }
    .iso-btn.active { background: #2e7d32; color: white; border-color: #2e7d32; }

    /* --- SIDEBAR --- */
    #sidebar {
        position: absolute; top: 80px; left: 20px; width: 320px; bottom: 30px;
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
        color: #333; padding: 0; border-radius: 12px; border: 1px solid #e0e0e0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 10;
        display: flex; flex-direction: column; overflow: hidden;
    }

    .header { padding: 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
    h2 { margin: 0; font-size: 18px; font-weight: 700; color: #222; letter-spacing: -0.5px; }
    p.sub { margin: 5px 0 0; font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

    .layer-group { border-bottom: 1px solid #eee; }
    .layer-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; cursor: pointer; transition: 0.2s; }
    .layer-header:hover { background: #f9f9f9; }
    .layer-title { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #444; }
    .arrow { font-size: 10px; color: #999; transition: 0.3s; }
    .arrow.rotated { transform: rotate(180deg); }

    .toggle { position: relative; display: inline-block; width: 32px; height: 18px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ddd; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: #333; }
    input:checked + .slider:before { transform: translateX(14px); }

    #tree-content { display: block; padding: 0; background: #fff; max-height: 60vh; overflow-y: auto; border-top: 1px solid #eee; }
    #tree-content.collapsed { display: none; }

    .search-container { padding: 15px 20px 10px; position: sticky; top: 0; background: #fff; z-index: 5; border-bottom: 1px solid #f5f5f5; }
    .search-input { width: 100%; box-sizing: border-box; background: #f7f7f7; border: 1px solid #e0e0e0; color: #333; padding: 8px 12px; border-radius: 6px; font-family: 'Inter'; font-size: 12px; outline: none; transition: 0.2s; }
    .search-input:focus { border-color: #999; background: #fff; }

    .filter-tools { padding: 10px 20px; display: flex; gap: 10px; background: #fff; }
    .mini-btn { font-size: 10px; background: #f0f0f0; border: 1px solid #ddd; color: #666; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; }
    .mini-btn:hover { background: #e0e0e0; color: #333; }

    .legend-container { padding: 0 20px 20px; background: #fff; }
    .chip-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 20px; font-size: 11px; color: #555; cursor: pointer; transition: all 0.2s ease; user-select: none; }
    .chip:hover { background: #f5f5f5; color: #000; border-color: #ccc; }
    .chip.active { background: #e8f5e9; color: #1b5e20; border-color: #a5d6a7; } 
    .chip-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    
    /* --- POPUP & STREET VIEW --- */
    .mapboxgl-popup { max-width: 360px !important; z-index: 50; }
    .mapboxgl-popup-content { background: #fff; color: #333; border: 1px solid #ddd; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    
    .street-view-container { height: 200px; width: 100%; background: #eee; position: relative; border-bottom: 1px solid #ddd; }
    .street-view-iframe { width: 100%; height: 100%; border: none; }
    .sv-helper-text { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; font-size: 10px; border-radius: 4px; pointer-events: none; }
    
    .popup-body { padding: 20px; }
    .popup-title { font-size: 22px; font-weight: 700; color: #222; font-style: italic; margin-bottom: 4px; line-height: 1.1; font-family: 'Times New Roman', serif; }
    .coord-debug { font-size: 9px; color: #999; font-family: monospace; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 4px; display: block; }

    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    .data-box { background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    .data-label { font-size: 9px; color: #888; text-transform: uppercase; font-weight: 700; }
    .data-value { font-size: 13px; font-weight: 600; color: #333; }
    
    .address-box { font-size: 11px; color: #666; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;}
    .leaf-specimen { display: flex; align-items: center; gap: 15px; background: #f4f4f4; padding: 10px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #eee; }
    .leaf-img { width: 45px; height: 45px; object-fit: contain; mix-blend-mode: multiply; filter: contrast(1.1); }
    .leaf-info span { display: block; color: #444; }
    
    .btn-row { display: flex; gap: 10px; }
    .btn-wiki { flex: 1; text-align: center; padding: 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; background: #eee; color: #333; transition: 0.2s;}
    .btn-wiki:hover { background: #ddd; }
    
    .mapboxgl-popup-close-button { color: #fff; font-size: 24px; padding: 5px 12px; z-index: 10; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
</style>
</head>
<body>

<div id="top-bar">
    <button class="b-btn active" onclick="setBorough('All', this)">NYC All</button>
    <button class="b-btn" onclick="setBorough('Manhattan', this)">Manhattan</button>
    <button class="b-btn" onclick="setBorough('Brooklyn', this)">Brooklyn</button>
    <button class="b-btn" onclick="setBorough('Queens', this)">Queens</button>
    <button class="b-btn" onclick="setBorough('Bronx', this)">Bronx</button>
    <button class="b-btn" onclick="setBorough('Staten Island', this)">Staten Island</button>
    <button class="b-btn iso-btn" onclick="toggleIsometric(this)" style="margin-left: 10px;">3D View</button>
</div>

<div id="sidebar">
    <div class="header">
        <h2>NYC Forestry Map</h2>
        <p class="sub">Custom Leaf Icons</p>
    </div>
    
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title" onclick="toggleTreeAccordion()">
                <span class="arrow rotated" id="tree-arrow">‚ñº</span> Trees (Nature)
            </div>
            <label class="toggle">
                <input type="checkbox" checked id="chk-trees-master" onchange="toggleMasterTreeLayer()">
                <span class="slider"></span>
            </label>
        </div>
        <div id="tree-content">
            <div class="search-container">
                <input type="text" id="species-search" class="search-input" placeholder="Search ANY species..." oninput="handleSearchInput()">
            </div>
            <div class="filter-tools">
                <button class="mini-btn" onclick="toggleAll(true)">Select All</button>
                <button class="mini-btn" onclick="toggleAll(false)">Clear</button>
            </div>
            <div class="legend-container">
                <div class="chip-grid" id="chip-container"></div>
            </div>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Parks (Stippled)</div>
            <label class="toggle"><input type="checkbox" id="chk-parks" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Water (Shaded)</div>
            <label class="toggle"><input type="checkbox" id="chk-water" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group" style="border-bottom: none;">
        <div class="layer-header">
            <div class="layer-title">Buildings (Dark Fill)</div>
            <label class="toggle"><input type="checkbox" id="chk-buildings" checked><span class="slider"></span></label>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW9saXM3MjYiLCJhIjoiY21oeHFrNGxhMDEzYzJrcHk0czJqejVlbCJ9.qLIfPy7V7FfgnEWg6CPQcA';

    const TILESET_ID = 'molis726.440hoo1z';
    const LAYER_NAME = 'Forestry_Tree_Points-81mjz0';
    const COL = { SPECIES: 'GenusSpecies', DBH: 'DBH', HEALTH: 'TPCondition', BOROUGH: 'boroname' };

    const treeCatalog = [
        { label: 'Platanus', keyword: 'Platanus', color: '#8cb369' }, 
        { label: 'Acer (Maple)', keyword: 'Acer', color: '#2d6a4f' }, 
        { label: 'Quercus (Oak)', keyword: 'Quercus', color: '#40916c' }, 
        { label: 'Gleditsia', keyword: 'Gleditsia', color: '#b7e4c7' }, 
        { label: 'Tilia (Linden)', keyword: 'Tilia', color: '#52b788' }, 
        { label: 'Pyrus (Pear)', keyword: 'Pyrus', color: '#a8d5ba' }, 
        { label: 'Prunus (Cherry)', keyword: 'Prunus', color: '#95d5b2' }, 
        { label: 'Zelkova', keyword: 'Zelkova', color: '#1b4332' }, 
        { label: 'Ginkgo', keyword: 'Ginkgo', color: '#d9ed92' }, 
        { label: 'Fraxinus (Ash)', keyword: 'Fraxinus', color: '#74c69d' }, 
        { label: 'Liquidambar', keyword: 'Liquidambar', color: '#55a630' }, 
        { label: 'Ulmus (Elm)', keyword: 'Ulmus', color: '#2b9348' }, 
        { label: 'Styphnolobium', keyword: 'Styphnolobium', color: '#e9ff70' }, 
        { label: 'Pinus (Pine)', keyword: 'Pinus', color: '#081c15' }, 
        { label: 'Metasequoia', keyword: 'Metasequoia', color: '#80b918' }, 
        { label: 'Magnolia', keyword: 'Magnolia', color: '#ccff33' }
    ];

    // Para la imagen en el popup (foto real)
    const leafImages = {
        'Acer': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Acer_pseudoplatanus_leaf_2.jpg/240px-Acer_pseudoplatanus_leaf_2.jpg',
        'Quercus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Quercus_robur_leaf_01.jpg/240px-Quercus_robur_leaf_01.jpg',
        'Platanus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/Platanus_occidentalis_1.jpg/240px-Platanus_occidentalis_1.jpg',
        'Ginkgo': 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Ginkgo_biloba_Scanned_Leaf.jpg/240px-Ginkgo_biloba_Scanned_Leaf.jpg',
        'Gleditsia': 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Gleditsia_triacanthos_leaf.jpg/240px-Gleditsia_triacanthos_leaf.jpg',
        'DEFAULT': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Leaf_icon_03.svg/240px-Leaf_icon_03.svg.png'
    };

    let activeGenera = treeCatalog.map(t => t.keyword);
    let currentBorough = 'All';
    let isTreeLayerOn = true;
    let isIsometric = false;

    const map = new mapboxgl.Map({
        container: 'map',
        style: {
            "version": 8,
            "name": "Pencil-Architect",
            "sources": {
                "composite": { "url": "mapbox://mapbox.mapbox-streets-v8", "type": "vector" },
                "nyc-forestry": { "type": "vector", "url": "mapbox://" + TILESET_ID }
            },
            "layers": [
                { "id": "background", "type": "background", "paint": { "background-color": "#FDFCF6" } }
            ]
        },
        center: [-73.970, 40.782], zoom: 11, pitch: 0, bearing: 0
    });
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

    // =========================================================================
    // L√ìGICA DE CARGA DE TUS ARCHIVOS SVG LOCALES
    // =========================================================================
    map.on('load', () => {

        // 1. CONFIGURA AQU√ç LA LISTA DE TUS ARCHIVOS SVG
        // 'file' debe ser exactamente el nombre del archivo en tu carpeta.
        const iconFiles = [
            { key: 'Ginkgo',      file: 'ginkgo.svg' }, 
            { key: 'Platanus',    file: 'platanus.svg' },
            { key: 'Acer',        file: 'acer.svg' },
            { key: 'Quercus',     file: 'quercus.svg' },
            { key: 'Gleditsia',   file: 'gleditsia.svg' },
            { key: 'Tilia',       file: 'tilia.svg' },
            { key: 'Pinus',       file: 'pinus.svg' },
            { key: 'Prunus',      file: 'prunus.svg' },
            { key: 'Pyrus',       file: 'pyrus.svg' },
            { key: 'Zelkova',     file: 'zelkova.svg' },
            { key: 'Liquidambar', file: 'liquidambar.svg' },
            { key: 'Fraxinus',    file: 'fraxinus.svg' },
            { key: 'Ulmus',       file: 'ulmus.svg' },
            { key: 'Magnolia',    file: 'magnolia.svg' }
        ];

        // 2. FUNCI√ìN AUTOM√ÅTICA PARA CARGARLOS
        const loadCustomIcon = (name, url) => {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`No se encuentra: ${url}`);
                    return response.text();
                })
                .then(svgContent => {
                    const i = new Image();
                    // Codificamos el SVG a base64
                    i.src = 'data:image/svg+xml;base64,' + btoa(svgContent);
                    i.onload = () => {
                        const c = document.createElement('canvas');
                        c.width = 64; c.height = 64; // Alta resoluci√≥n
                        const ctx = c.getContext('2d');
                        ctx.drawImage(i, 0, 0, 64, 64);
                        
                        // Agregar al mapa con SDF (para poder colorear)
                        if (!map.hasImage(name)) {
                            map.addImage(name, {
                                width: 64, height: 64,
                                data: ctx.getImageData(0, 0, 64, 64).data
                            }, { sdf: true });
                        }
                    };
                })
                .catch(err => console.log('Error cargando icono:', err.message));
        };

        // Ejecutar carga de archivos
        iconFiles.forEach(item => loadCustomIcon(item.key + '-icon', item.file));

        // 3. ICONOS POR DEFECTO (C√≠rculo y Palo 3D)
        const cC=document.createElement('canvas');cC.width=32;cC.height=32;const ctxC=cC.getContext('2d');
        ctxC.fillStyle='#ffffff';ctxC.beginPath();ctxC.arc(16,16,12,0,Math.PI*2);ctxC.fill();
        map.addImage('circle-icon', {width:32,height:32,data:ctxC.getImageData(0,0,32,32).data}, {sdf:true});

        const cS=document.createElement('canvas');cS.width=20;cS.height=80;const ctxS=cS.getContext('2d');
        const grd=ctxS.createLinearGradient(0,0,20,0); grd.addColorStop(0,"rgba(80,120,80,0.7)"); grd.addColorStop(0.5,"rgba(100,150,100,1)"); grd.addColorStop(1,"rgba(80,120,80,0.7)");
        ctxS.fillStyle=grd;ctxS.fillRect(0,0,20,80);
        map.addImage('tree-stick', {width:20,height:80,data:ctxS.getImageData(0,0,20,80).data}, {sdf:true});

        // 4. CAPAS DE FONDO
        map.addLayer({ 'id': 'custom-parks', 'type': 'fill', 'source': 'composite', 'source-layer': 'landuse', 'filter': ['==', 'class', 'park'], 'paint': { 'fill-color': '#E8EAE6', 'fill-opacity': 1 } });
        map.addLayer({ 'id': 'custom-water', 'type': 'fill', 'source': 'composite', 'source-layer': 'water', 'paint': { 'fill-color': '#CAD2D3', 'fill-opacity': 1 } });
        map.addLayer({ 'id': 'custom-buildings', 'type': 'fill', 'source': 'composite', 'source-layer': 'building', 'paint': { 'fill-color': '#444444', 'fill-opacity': 0.6, 'fill-outline-color': '#222222' } });

        // 5. DEFINICI√ìN DE COLORES
        const colorExpr = ['case'];
        treeCatalog.forEach(t => {
            colorExpr.push(['in', t.keyword, ['get', COL.SPECIES]]);
            colorExpr.push(t.color);
        });
        colorExpr.push('#60993E'); 

        // 6. L√ìGICA DE ICONOS AUTOM√ÅTICA
        // Construimos la regla 'case' basada en tu lista de archivos
        const iconLogic = ['case'];
        iconFiles.forEach(item => {
            // Si la especie contiene "Acer", usa "Acer-icon"
            iconLogic.push(['in', item.key, ['get', COL.SPECIES]]);
            iconLogic.push(item.key + '-icon');
        });
        iconLogic.push('circle-icon'); // Fallback

        // CAPA PRINCIPAL (PUNTOS)
        map.addLayer({
            'id': 'trees-points',
            'type': 'symbol',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'layout': {
                'icon-image': [
                    'step', ['zoom'], 'circle-icon', 14, // Zoom lejos: c√≠rculos
                    iconLogic                            // Zoom cerca: tus SVGs
                ],
                'icon-size': ['interpolate', ['linear'], ['zoom'], 11, 0.3, 14, 0.6, 18, 1.0],
                'icon-allow-overlap': true,
                'icon-anchor': 'center'
            },
            'paint': { 'icon-color': colorExpr, 'icon-opacity': 0.8 }
        });

        // CAPA 3D
        map.addLayer({
            'id': 'trees-sticks',
            'type': 'symbol',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'layout': { 'visibility': 'none', 'icon-image': 'tree-stick', 'icon-allow-overlap': true, 'icon-anchor': 'bottom', 'icon-pitch-alignment': 'viewport', 'icon-size': 0.75 },
            'paint': { 'icon-color': colorExpr, 'icon-opacity': 1 }
        });

        buildChipGrid();
        setupInteractions();
    });

    // --- LOGICA DE FILTRO Y UI ---
    function handleSearchInput() {
        const searchVal = document.getElementById('species-search').value.toLowerCase();
        const chips = document.querySelectorAll('.chip');
        if (searchVal.length > 0) {
            chips.forEach(c => c.style.opacity = "0.3"); 
        } else {
            chips.forEach(c => { 
                const keyword = c.getAttribute('data-key');
                c.style.opacity = activeGenera.includes(keyword) ? "1" : "0.5";
            });
        }
        applyMapFilters();
    }

    function applyMapFilters() {
        if (!isTreeLayerOn) return;
        const searchVal = document.getElementById('species-search').value.trim();
        const filters = ['all'];

        if (currentBorough !== 'All') filters.push(['==', COL.BOROUGH, currentBorough]);

        if (searchVal.length > 0) {
            filters.push(['!=', ['index-of', searchVal.toUpperCase(), ['upcase', ['get', COL.SPECIES]]], -1]);
        } else {
            if (activeGenera.length > 0) {
                const speciesConditions = ['any'];
                activeGenera.forEach(keyword => speciesConditions.push(['in', keyword, ['get', COL.SPECIES]]));
                filters.push(speciesConditions);
            } else {
                filters.push(['==', COL.SPECIES, 'IMPOSSIBLE']);
            }
        }
        map.setFilter('trees-points', filters);
        map.setFilter('trees-sticks', filters);
    }

    // --- INTERACCI√ìN ---
    function setupInteractions() {
        const layers = ['trees-points', 'trees-sticks'];
        layers.forEach(layerID => {
            map.on('mouseenter', layerID, () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', layerID, () => map.getCanvas().style.cursor = '');

            map.on('click', layerID, async (e) => {
                if (!isTreeLayerOn) return;
                const p = e.features[0].properties;
                const coords = e.features[0].geometry.coordinates; 
                const lat = coords[1];
                const lon = coords[0];
                const species = p[COL.SPECIES] || 'Unknown';
                const dbh = p[COL.DBH] || 0;
                const health = p[COL.HEALTH] || 'N/A';
                const leafUrl = getLeafImage(species);

                const svUrl = `https://maps.google.com/maps?q=&layer=c&cbll=${lat},${lon}&cbp=11,0,0,0,0&output=svembed&layer=c`; 
                const svLink = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lon}&layer=c`;

                new mapboxgl.Popup({ closeButton: true, offset: [0, -20], maxWidth: '360px' })
                    .setLngLat(coords)
                    .setHTML(`
                        <div class="street-view-container">
                            <span class="sv-helper-text">‚Ü∫ Rotate to find tree</span>
                            <iframe class="street-view-iframe" src="${svUrl}" frameborder="0" allowfullscreen></iframe>
                            <a href="${svLink}" target="_blank" style="position:absolute; bottom:8px; right:8px; background:rgba(255,255,255,0.95); padding:6px 10px; font-size:10px; border-radius:4px; text-decoration:none; color:#d32f2f; font-weight:700; box-shadow:0 2px 4px rgba(0,0,0,0.2); border:1px solid #ffcdd2;">
                                ‚Üó Fix View (App)
                            </a>
                        </div>
                        <div class="popup-body">
                            <div class="popup-title">${species}</div>
                            <span class="coord-debug">Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}</span>
                            
                            <div class="address-box"><span>üìç</span><span id="addr-real">Locating address...</span></div>
                            
                            <div class="leaf-specimen">
                                <img src="${leafUrl}" class="leaf-img">
                                <div class="leaf-info">
                                    <span style="font-size:10px; color:#888; text-transform:uppercase; font-weight:700">Foliage ID</span>
                                    <span style="font-size:14px; font-weight:600; color:#333">Specimen View</span>
                                </div>
                            </div>

                            <div class="data-grid">
                                <div class="data-box"><span class="data-label">Health</span><span class="data-value" style="color:${health.includes('Good')?'#2e7d32':'#ef6c00'}">${health}</span></div>
                                <div class="data-box"><span class="data-label">Diameter</span><span class="data-value">${dbh}"</span></div>
                            </div>
                            
                            <div class="btn-row">
                                <a href="https://en.wikipedia.org/wiki/${species.split(' ')[0]}" target="_blank" class="btn-wiki">Wikipedia Info</a>
                            </div>
                        </div>
                    `)
                    .addTo(map);

                // Reverse Geocoding
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    let fullAddr = data.display_name.split(',')[0];
                    if (data.address && data.address.house_number && (data.address.road || data.address.street)) {
                        fullAddr = `${data.address.house_number} ${data.address.road || data.address.street}`;
                    }
                    document.getElementById('addr-real').innerText = fullAddr;
                } catch (err) {
                    document.getElementById('addr-real').innerText = "Address unavailable";
                }
            });
        });

        document.getElementById('chk-parks').addEventListener('change', e => map.setLayoutProperty('custom-parks', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-water').addEventListener('change', e => map.setLayoutProperty('custom-water', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-buildings').addEventListener('change', e => map.setLayoutProperty('custom-buildings', 'visibility', e.target.checked ? 'visible' : 'none'));
    }

    function setBorough(boro, btn) {
        currentBorough = boro;
        document.querySelectorAll('.b-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyMapFilters(); 
        const locations = { 'Manhattan': [-73.97, 40.78], 'Brooklyn': [-73.95, 40.65], 'Queens': [-73.85, 40.73], 'Bronx': [-73.87, 40.85], 'Staten Island': [-74.15, 40.57] };
        if(locations[boro]) map.flyTo({ center: locations[boro], zoom: 14, pitch: isIsometric ? 60 : 0 });
        else map.flyTo({ center: [-73.97, 40.78], zoom: 11, pitch: isIsometric ? 60 : 0 });
    }

    function toggleIsometric(btn) {
        isIsometric = !isIsometric;
        btn.classList.toggle('active');
        if (isIsometric) {
            map.flyTo({ pitch: 60, bearing: -45, zoom: map.getZoom() < 13 ? 13 : map.getZoom() });
            if (isTreeLayerOn) { map.setLayoutProperty('trees-points', 'visibility', 'none'); map.setLayoutProperty('trees-sticks', 'visibility', 'visible'); }
        } else {
            map.flyTo({ pitch: 0, bearing: 0 });
            if (isTreeLayerOn) { map.setLayoutProperty('trees-points', 'visibility', 'visible'); map.setLayoutProperty('trees-sticks', 'visibility', 'none'); }
        }
    }

    function toggleMasterTreeLayer() {
        isTreeLayerOn = document.getElementById('chk-trees-master').checked;
        const visibility = isTreeLayerOn ? 'visible' : 'none';
        map.setLayoutProperty(isIsometric ? 'trees-sticks' : 'trees-points', 'visibility', visibility);
        document.getElementById('tree-content').classList.toggle('collapsed', !isTreeLayerOn);
    }

    function buildChipGrid() {
        const container = document.getElementById('chip-container');
        container.innerHTML = '';
        treeCatalog.forEach(t => {
            const chip = document.createElement('div');
            chip.className = 'chip active';
            chip.setAttribute('data-key', t.keyword);
            chip.onclick = () => toggleChip(t.keyword, chip);
            let dotHTML = `<div class="chip-dot" style="background:${t.color}"></div>`;
            chip.innerHTML = dotHTML + `<span>${t.label}</span>`;
            container.appendChild(chip);
        });
    }

    function toggleChip(keyword, element) {
        document.getElementById('species-search').value = ''; 
        document.querySelectorAll('.chip').forEach(c => {
            if(activeGenera.includes(c.getAttribute('data-key'))) c.style.opacity = '1';
            else c.style.opacity = '0.5';
        });

        if (activeGenera.includes(keyword)) {
            activeGenera = activeGenera.filter(k => k !== keyword);
            element.classList.remove('active');
            element.style.opacity = "0.5";
        } else {
            activeGenera.push(keyword);
            element.classList.add('active');
            element.style.opacity = "1";
        }
        applyMapFilters();
    }

    function toggleAll(selectAll) {
        document.getElementById('species-search').value = '';
        const chips = document.querySelectorAll('.chip');
        if (selectAll) {
            activeGenera = treeCatalog.map(t => t.keyword);
            chips.forEach(c => { c.classList.add('active'); c.style.opacity = "1"; });
        } else {
            activeGenera = [];
            chips.forEach(c => { c.classList.remove('active'); c.style.opacity = "0.5"; });
        }
        applyMapFilters();
    }

    function getLeafImage(speciesName) {
        for (const [genus, url] of Object.entries(leafImages)) {
            if (speciesName.includes(genus)) return url;
        }
        return leafImages['DEFAULT'];
    }
</script>
</body>
</html>
