<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>NYC Forestry: Final Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    body { margin: 0; padding: 0; background-color: #FDFCF6; font-family: 'Inter', sans-serif; overflow: hidden; color: #333; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; background-color: #FDFCF6; }

    #top-bar {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 8px; z-index: 20;
        background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 4px;
        backdrop-filter: blur(8px); border: 1px solid #ddd; overflow-x: auto; max-width: 95%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); scrollbar-width: none;
    }
    #top-bar::-webkit-scrollbar { display: none; }
    
    .b-btn {
        background: transparent; border: none; color: #666;
        padding: 8px 16px; border-radius: 2px; cursor: pointer; font-size: 11px; font-weight: 600;
        transition: 0.2s; white-space: nowrap; font-family: 'Inter'; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .b-btn:hover { color: #000; background: #f0f0f0; }
    .b-btn.active { background: #333; color: #fff; }
    .iso-btn { background: #eee; color: #555; border: 1px solid #ddd; }
    .iso-btn:hover { background: #ddd; color: #000; }
    .iso-btn.active { background: #2e7d32; color: white; border-color: #2e7d32; }

    #sidebar {
        position: absolute; top: 80px; left: 20px; width: 320px; bottom: 30px;
        background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
        color: #333; padding: 0; border-radius: 4px; border: 1px solid #e0e0e0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); z-index: 10;
        display: flex; flex-direction: column; overflow: hidden;
    }

    .header { padding: 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
    h2 { margin: 0; font-size: 16px; font-weight: 700; color: #222; text-transform: uppercase; letter-spacing: 1px; }
    p.sub { margin: 5px 0 0; font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }

    .layer-group { border-bottom: 1px solid #eee; }
    .layer-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; cursor: pointer; transition: 0.2s; }
    .layer-header:hover { background: #f9f9f9; }
    .layer-title { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #444; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .arrow { display: inline-block; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 6px solid #999; transition: 0.3s; }
    .arrow.rotated { transform: rotate(180deg); }

    .toggle { position: relative; display: inline-block; width: 32px; height: 18px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ddd; transition: .4s; border-radius: 0; } 
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: #333; }
    input:checked + .slider:before { transform: translateX(14px); }

    #tree-content { display: block; padding: 0; background: #fff; max-height: 60vh; overflow-y: auto; border-top: 1px solid #eee; }
    #tree-content.collapsed { display: none; }

    .search-container { padding: 15px 20px 10px; position: sticky; top: 0; background: #fff; z-index: 5; border-bottom: 1px solid #f5f5f5; }
    .search-input { width: 100%; box-sizing: border-box; background: #f7f7f7; border: 1px solid #e0e0e0; color: #333; padding: 8px 12px; border-radius: 0; font-family: 'Inter'; font-size: 12px; outline: none; transition: 0.2s; }
    .search-input:focus { border-color: #333; background: #fff; }

    .filter-tools { padding: 10px 20px; display: flex; gap: 10px; background: #fff; }
    .mini-btn { font-size: 10px; background: #f0f0f0; border: 1px solid #ddd; color: #666; padding: 4px 10px; border-radius: 0; cursor: pointer; font-weight: 600; text-transform: uppercase; }
    .mini-btn:hover { background: #e0e0e0; color: #333; }

    .legend-container { padding: 0 20px 20px; background: #fff; }
    .chip-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 0; font-size: 11px; color: #555; cursor: pointer; transition: all 0.2s ease; user-select: none; }
    .chip:hover { background: #f5f5f5; color: #000; border-color: #ccc; }
    .chip.active { background: #e8f5e9; color: #1b5e20; border-color: #a5d6a7; } 
    .chip-dot { width: 8px; height: 8px; border-radius: 0; flex-shrink: 0; }

    #fullscreen-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: none; 
        flex-direction: row; 
        overflow: hidden;
    }
    
    #fs-sidebar {
        width: 340px; background: #fff; border-right: 1px solid #ddd;
        overflow-y: auto; display: flex; flex-direction: column; flex-shrink: 0;
        position: absolute; left: 0; top: 0; bottom: 0; z-index: 10002;
        transform: translateX(-100%); 
        transition: transform 0.3s ease-in-out;
        box-shadow: 2px 0 15px rgba(0,0,0,0.3);
    }
    #fs-sidebar.open { transform: translateX(0); }

    #fs-controls-header {
        position: absolute; top: 20px; left: 20px; right: 20px;
        display: flex; justify-content: space-between; z-index: 10005;
        pointer-events: none; 
    }

    .fs-float-btn {
        pointer-events: auto;
        background: rgba(255, 255, 255, 0.9); color: #333; border: 1px solid #ccc; 
        padding: 10px 18px; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 12px;
        font-family: 'Inter'; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .fs-float-btn:hover { background: #fff; color: #000; box-shadow: 0 6px 14px rgba(0,0,0,0.15); }
    
    .fs-hero-img { width: 100%; height: 200px; object-fit: cover; }
    .fs-content { padding: 25px; }
    
    .fs-title { 
        font-size: 24px; font-weight: 700; color: #222; font-style: italic; 
        margin-bottom: 4px; line-height: 1.1; font-family: 'Times New Roman', serif; 
        border-bottom: none;
    }
    .coord-debug { font-size: 10px; color: #999; font-family: monospace; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: block; }
    
    .fs-address-box { font-size: 12px; color: #666; margin-bottom: 15px; display: flex; align-items: center; gap: 6px; }

    .fs-data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .fs-data-box { 
        background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #eee; 
        text-align: left; display: flex; justify-content: space-between; align-items: center; 
    }
    .fs-label { font-size: 9px; color: #888; text-transform: uppercase; font-weight: 700; }
    .fs-value { font-size: 13px; font-weight: 600; color: #333; }
    
    .fs-leaf-specimen { 
        display: flex; align-items: center; gap: 15px; background: #f4f4f4; 
        padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; 
    }
    .fs-leaf-img { width: 45px; height: 45px; object-fit: contain; mix-blend-mode: multiply; filter: contrast(1.1); }
    
    .fs-btn-wiki { 
        display: block; width: 100%; text-align: center; padding: 12px; border-radius: 8px; 
        font-size: 12px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; 
        background: #eee; color: #333; transition: 0.2s; box-sizing: border-box;
    }
    .fs-btn-wiki:hover { background: #ddd; }

    #fs-body { flex: 1; position: relative; width: 100%; height: 100%; }
    #fs-pano { width: 100%; height: 100%; }

</style>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
</head>
<body>

<div id="fullscreen-overlay">
    
    <div id="fs-controls-header">
        <button class="fs-float-btn" onclick="toggleFullscreenSidebar()">
            ‚Ñπ INFO
        </button>
        <button class="fs-float-btn" onclick="closeFullscreen()" style="background: #d32f2f; color: white; border: none;">
            ‚úï CLOSE VIEW
        </button>
    </div>

    <div id="fs-sidebar">
        <img id="fs-tree-photo" class="fs-hero-img" src="" alt="Tree Photo">
        
        <div class="fs-content">
            <div id="fs-tree-name" class="fs-title">Tree Name</div>
            <span id="fs-coords" class="coord-debug">Coordinates...</span>
            
            <div class="fs-address-box">
                <span>üìç</span><span id="fs-addr-text">Locating address...</span>
            </div>
            
            <div class="fs-leaf-specimen">
                <img id="fs-leaf-icon" class="fs-leaf-img" src="">
                <div class="leaf-info">
                    <span style="font-size:10px; color:#888; text-transform:uppercase; font-weight:700; display:block;">Foliage ID</span>
                    <span style="font-size:14px; font-weight:600; color:#333;">Specimen View</span>
                </div>
            </div>

            <div class="fs-data-grid">
                <div class="fs-data-box">
                    <span class="fs-label">Health</span>
                    <span id="fs-health" class="fs-value">Good</span>
                </div>
                <div class="fs-data-box">
                    <span class="fs-label">Diameter</span>
                    <span id="fs-dbh" class="fs-value">0"</span>
                </div>
            </div>

            <a id="fs-wiki-link" href="#" target="_blank" class="fs-btn-wiki">Wikipedia Info</a>
        </div>
    </div>
    
    <div id="fs-body">
        <div id="fs-pano"></div>
    </div>
</div>

<div id="top-bar">
    <button class="b-btn active" onclick="setBorough('All', this)">NYC All</button>
    <button class="b-btn" onclick="setBorough('Manhattan', this)">Manhattan</button>
    <button class="b-btn" onclick="setBorough('Brooklyn', this)">Brooklyn</button>
    <button class="b-btn" onclick="setBorough('Queens', this)">Queens</button>
    <button class="b-btn" onclick="setBorough('Bronx', this)">Bronx</button>
    <button class="b-btn" onclick="setBorough('Staten Island', this)">Staten Island</button>
    <button class="b-btn iso-btn" onclick="toggleIsometric(this)" style="margin-left: 10px;">3D</button>
</div>

<div id="sidebar">
    <div class="header">
        <h2>NYC Forestry Map</h2>
        <p class="sub">Architectural View</p>
    </div>
    
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title" onclick="toggleTreeAccordion()">
                <span class="arrow rotated" id="tree-arrow"></span> Trees (Points)
            </div>
            <label class="toggle">
                <input type="checkbox" checked id="chk-trees-master" onchange="toggleMasterTreeLayer()">
                <span class="slider"></span>
            </label>
        </div>
        <div id="tree-content">
            <div class="search-container">
                <input type="text" id="species-search" class="search-input" placeholder="Search species..." oninput="handleSearchInput()">
            </div>
            <div class="filter-tools">
                <button class="mini-btn" onclick="toggleAll(true)">Select All</button>
                <button class="mini-btn" onclick="toggleAll(false)">Clear</button>
            </div>
            <div class="legend-container">
                <div class="chip-grid" id="chip-container"></div>
            </div>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Parks</div>
            <label class="toggle"><input type="checkbox" id="chk-parks" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Water</div>
            <label class="toggle"><input type="checkbox" id="chk-water" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group" style="border-bottom: none;">
        <div class="layer-header">
            <div class="layer-title">Buildings</div>
            <label class="toggle"><input type="checkbox" id="chk-buildings" checked><span class="slider"></span></label>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW9saXM3MjYiLCJhIjoiY21oeHFrNGxhMDEzYzJrcHk0czJqejVlbCJ9.qLIfPy7V7FfgnEWg6CPQcA';
    
    // API KEY
    const GOOGLE_API_KEY = 'AIzaSyBG8cgbuB2liZMmiZsepAXMMDYoYxk0cFwk'; 

    const TILESET_ID = 'molis726.440hoo1z';
    const LAYER_NAME = 'Forestry_Tree_Points-81mjz0';
    const COL = { SPECIES: 'GenusSpecies', DBH: 'DBH', HEALTH: 'TPCondition', BOROUGH: 'boroname' };

    const treeCatalog = [
        { label: 'Platanus', keyword: 'Platanus', color: '#8cb369' }, 
        { label: 'Acer (Maple)', keyword: 'Acer', color: '#2d6a4f' }, 
        { label: 'Quercus (Oak)', keyword: 'Quercus', color: '#40916c' }, 
        { label: 'Gleditsia', keyword: 'Gleditsia', color: '#b7e4c7' }, 
        { label: 'Tilia (Linden)', keyword: 'Tilia', color: '#52b788' }, 
        { label: 'Pyrus (Pear)', keyword: 'Pyrus', color: '#a8d5ba' }, 
        { label: 'Prunus (Cherry)', keyword: 'Prunus', color: '#95d5b2' }, 
        { label: 'Zelkova', keyword: 'Zelkova', color: '#1b4332' }, 
        { label: 'Ginkgo', keyword: 'Ginkgo', color: '#d9ed92' }, 
        { label: 'Fraxinus (Ash)', keyword: 'Fraxinus', color: '#74c69d' }, 
        { label: 'Liquidambar', keyword: 'Liquidambar', color: '#55a630' }, 
        { label: 'Ulmus (Elm)', keyword: 'Ulmus', color: '#2b9348' }, 
        { label: 'Styphnolobium', keyword: 'Styphnolobium', color: '#e9ff70' }, 
        { label: 'Pinus (Pine)', keyword: 'Pinus', color: '#081c15' }, 
        { label: 'Metasequoia', keyword: 'Metasequoia', color: '#80b918' }, 
        { label: 'Magnolia', keyword: 'Magnolia', color: '#ccff33' }
    ];

    const leafImages = {
        'Acer': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Acer_pseudoplatanus_leaf_2.jpg/240px-Acer_pseudoplatanus_leaf_2.jpg',
        'Quercus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Quercus_robur_leaf_01.jpg/240px-Quercus_robur_leaf_01.jpg',
        'Platanus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/Platanus_occidentalis_1.jpg/240px-Platanus_occidentalis_1.jpg',
        'Ginkgo': 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Ginkgo_biloba_Scanned_Leaf.jpg/240px-Ginkgo_biloba_Scanned_Leaf.jpg',
        'Gleditsia': 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Gleditsia_triacanthos_leaf.jpg/240px-Gleditsia_triacanthos_leaf.jpg',
        'Tilia': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/Tilia_cordata_Leaf.jpg/240px-Tilia_cordata_Leaf.jpg',
        'Zelkova': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Zelkova_serrata_leaf.jpg/240px-Zelkova_serrata_leaf.jpg',
        'Ulmus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Ulmus_americana_Leaf.jpg/240px-Ulmus_americana_Leaf.jpg',
        'Styphnolobium': 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Styphnolobium_japonicum_leaf.jpg/240px-Styphnolobium_japonicum_leaf.jpg',
        'DEFAULT': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Leaf_icon_03.svg/240px-Leaf_icon_03.svg.png'
    };

    let activeGenera = treeCatalog.map(t => t.keyword);
    let currentBorough = 'All';
    let isTreeLayerOn = true;
    let isIsometric = false;

    function loadGoogleMapsApi() {
        if (window.google && window.google.maps) return; 
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }
    loadGoogleMapsApi();

    const map = new mapboxgl.Map({
        container: 'map',
        style: {
            "version": 8,
            "name": "Pencil-Architect",
            "sources": {
                "composite": { "url": "mapbox://mapbox.mapbox-streets-v8", "type": "vector" },
                "nyc-forestry": { "type": "vector", "url": "mapbox://" + TILESET_ID }
            },
            "layers": [
                { "id": "background", "type": "background", "paint": { "background-color": "#FDFCF6" } }
            ]
        },
        center: [-73.970, 40.782], zoom: 11, pitch: 0, bearing: 0
    });
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');


    map.on('load', () => {

        const iconFiles = [
            { key: 'Ginkgo',      file: 'ginko.svg' },
            { key: 'Platanus',    file: 'platanus.svg' },
            { key: 'Acer',        file: 'maple.svg' },
            { key: 'Quercus',     file: 'oak.svg' },
            { key: 'Gleditsia',   file: 'Gleditsia.svg' },
            { key: 'Tilia',       file: 'tilia.svg' },
            { key: 'Pinus',       file: 'pine.svg' },
            { key: 'Prunus',      file: 'cherry.svg' },
            { key: 'Pyrus',       file: 'pyrus.svg' },
            { key: 'Zelkova',     file: 'zelkova.svg' },
            { key: 'Liquidambar', file: 'liquidambar.svg' },
            { key: 'Fraxinus',    file: 'fraxinus.svg' },
            { key: 'Metasequoia', file: 'metasequoia.svg' },
            { key: 'Styphnolobium', file: 'styphnolobium.svg' },
            { key: 'Ulmus',       file: 'ulmus.svg' },
            { key: 'Magnolia',    file: 'magnolia.svg' }
        ];

        const loadCustomIcon = (name, url) => {
            fetch(url).then(r=>r.ok?r.text():'').then(svg=>{
                if(!svg)return;
                const i=new Image();i.src='data:image/svg+xml;base64,'+btoa(svg);
                i.onload=()=>{
                    const c=document.createElement('canvas');c.width=64;c.height=64;
                    const ctx=c.getContext('2d');ctx.drawImage(i,0,0,64,64);
                    if(!map.hasImage(name)) map.addImage(name,{width:64,height:64,data:ctx.getImageData(0,0,64,64).data},{sdf:true});
                };
            });
        };
        iconFiles.forEach(item => loadCustomIcon(item.key + '-icon', item.file));

        const cC=document.createElement('canvas');cC.width=32;cC.height=32;const ctxC=cC.getContext('2d');
        ctxC.fillStyle='#ffffff';ctxC.beginPath();ctxC.arc(16,16,12,0,Math.PI*2);ctxC.fill();
        map.addImage('circle-icon', {width:32,height:32,data:ctxC.getImageData(0,0,32,32).data}, {sdf:true});

        const cS=document.createElement('canvas');cS.width=20;cS.height=80;const ctxS=cS.getContext('2d');
        const grd=ctxS.createLinearGradient(0,0,20,0); grd.addColorStop(0,"rgba(80,120,80,0.7)"); grd.addColorStop(0.5,"rgba(100,150,100,1)"); grd.addColorStop(1,"rgba(80,120,80,0.7)");
        ctxS.fillStyle=grd;ctxS.fillRect(0,0,20,80);
        map.addImage('tree-stick', {width:20,height:80,data:ctxS.getImageData(0,0,20,80).data}, {sdf:true});

        // LAYERS 
        map.addLayer({ 'id': 'custom-parks', 'type': 'fill', 'source': 'composite', 'source-layer': 'landuse', 'filter': ['==', 'class', 'park'], 'paint': { 'fill-color': '#E6E6E6', 'fill-opacity': 1 } });
        map.addLayer({ 'id': 'custom-water', 'type': 'fill', 'source': 'composite', 'source-layer': 'water', 'paint': { 'fill-color': '#a2d9ff', 'fill-opacity': 1 } });
        map.addLayer({ 'id': 'custom-buildings', 'type': 'fill', 'source': 'composite', 'source-layer': 'building', 'paint': { 'fill-color': '#d9d9d9', 'fill-opacity': 0.8, 'fill-outline-color': '#bdbdbd' } });
        map.addLayer({
            'id': 'custom-buildings-3d',
            'type': 'fill-extrusion',
            'source': 'composite',
            'source-layer': 'building',
            'minzoom': 13,
            'layout': { 'visibility': 'none' },
            'paint': {
                'fill-extrusion-color': '#d9d9d9',
                'fill-extrusion-height': ['coalesce', ['get', 'height'], 10],
                'fill-extrusion-base': ['coalesce', ['get', 'min_height'], 0],
                'fill-extrusion-opacity': 0.85
            }
        });

        const colorExpr = ['case'];
        treeCatalog.forEach(t => {
            colorExpr.push(['in', t.keyword, ['get', COL.SPECIES]]);
            colorExpr.push(t.color);
        });
        colorExpr.push('#60993E'); 

        const iconLogic = ['case'];
        iconFiles.forEach(item => {
            iconLogic.push(['in', item.key, ['get', COL.SPECIES]]);
            iconLogic.push(item.key + '-icon');
        });
        iconLogic.push('circle-icon');

        map.addLayer({
            'id': 'trees-points',
            'type': 'symbol',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'layout': {
                'icon-image': [
                    'step', ['zoom'], 'circle-icon', 14, 
                    iconLogic                            
                ],
                'icon-size': ['interpolate', ['linear'], ['zoom'], 11, 0.3, 14, 0.6, 18, 1.0],
                'icon-allow-overlap': true,
                'icon-anchor': 'center'
            },
            'paint': { 'icon-color': colorExpr, 'icon-opacity': 0.8 }
        });

        map.addLayer({
            'id': 'trees-sticks',
            'type': 'symbol',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'layout': { 'visibility': 'none', 'icon-image': 'tree-stick', 'icon-allow-overlap': true, 'icon-anchor': 'bottom', 'icon-pitch-alignment': 'viewport', 'icon-size': 0.75 },
            'paint': { 'icon-color': colorExpr, 'icon-opacity': 1 }
        });

        map.addLayer({
            'id': 'trees-canopy',
            'type': 'symbol',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'layout': {
                'visibility': 'none',
                'icon-image': iconLogic,
                'icon-allow-overlap': true,
                'icon-anchor': 'bottom',
                'icon-offset': [0, -1.6],
                'icon-size': ['interpolate', ['linear'], ['zoom'], 11, 0.4, 14, 0.8, 18, 1.2]
            },
            'paint': { 'icon-color': colorExpr, 'icon-opacity': 0.95 }
        });

        buildChipGrid();
        setupInteractions();
    });

    // --- WIKIPEDIA LOGIC ---
    async function fetchWikipediaImage(fullString) {
        try {
            let cleanName = fullString.split('-')[0].trim();
            let words = cleanName.split(' ');
            if (words.length >= 2) {
                cleanName = `${words[0]}_${words[1]}`;
            } else {
                cleanName = words[0]; 
            }
            const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${cleanName}`;
            const response = await fetch(url);
            if (!response.ok) return null;
            const data = await response.json();
            if (data.originalimage) return data.originalimage.source;
            if (data.thumbnail) return data.thumbnail.source;
            return null;
        } catch (error) {
            return null;
        }
    }

    let panorama;
    let autoRotateInterval;

    async function openFullscreen(lat, lon, species, dbh, health) {
        const overlay = document.getElementById('fullscreen-overlay');
        const panoDiv = document.getElementById('fs-pano');
        const sidebar = document.getElementById('fs-sidebar');
        
        sidebar.classList.remove('open');
        overlay.style.display = 'flex';

        document.getElementById('fs-tree-name').innerText = species;
        document.getElementById('fs-health').innerText = health;
        const healthEl = document.getElementById('fs-health');
        healthEl.style.color = health === 'Good' ? '#2e7d32' : (health === 'Poor' ? '#d32f2f' : '#f57c00');
        
        document.getElementById('fs-dbh').innerText = dbh + '"';
        document.getElementById('fs-coords').innerText = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
        
        const linkName = species.split('-')[0].trim().replace(' ', '_');
        document.getElementById('fs-wiki-link').href = `https://en.wikipedia.org/wiki/${linkName}`;

        const photoImg = document.getElementById('fs-tree-photo');
        photoImg.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png'; // Clear
        const wikiImage = await fetchWikipediaImage(species);
        if (wikiImage) {
            photoImg.src = wikiImage;
        } else {
            photoImg.src = 'https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?auto=format&fit=crop&w=600&q=80';
        }
        
        const leafImg = document.getElementById('fs-leaf-icon');
        const leafUrl = getLeafImage(species);
        leafImg.onerror = function() { 
            this.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Leaf_icon_03.svg/100px-Leaf_icon_03.svg.png'; 
        };
        leafImg.src = leafUrl;

        document.getElementById('fs-addr-text').innerText = "Locating...";
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            let fullAddr = data.display_name.split(',')[0];
            if (data.address && data.address.house_number && (data.address.road || data.address.street)) {
                fullAddr = `${data.address.house_number} ${data.address.road || data.address.street}`;
            }
            document.getElementById('fs-addr-text').innerText = fullAddr;
        } catch (e) {
            document.getElementById('fs-addr-text').innerText = "Address unavailable";
        }

        // 2. GOOGLE MAPS PANORAMA
        if (!window.google || !window.google.maps) return;

        const treeLocation = new google.maps.LatLng(lat, lon);
        const svService = new google.maps.StreetViewService();
        
        svService.getPanorama({
            location: treeLocation,
            radius: 50,
            preference: google.maps.StreetViewPreference.NEAREST,
            source: google.maps.StreetViewSource.OUTDOOR
        }, (data, status) => {
            if (status === google.maps.StreetViewStatus.OK) {
                const carLocation = data.location.latLng;
                const heading = google.maps.geometry.spherical.computeHeading(carLocation, treeLocation);

                panorama = new google.maps.StreetViewPanorama(panoDiv, {
                    pano: data.location.pano,
                    pov: { heading: heading, pitch: 20 },
                    zoom: 1,
                    disableDefaultUI: true,
                    clickToGo: false
                });

                startAutoRotate();

                panorama.addListener('mousedown', stopAutoRotate);

            } else {
                panoDiv.innerHTML = '<div style="color:white; padding:50px; text-align:center;">No Street View available.</div>';
            }
        });
    }

    function toggleFullscreenSidebar() {
        const sidebar = document.getElementById('fs-sidebar');
        sidebar.classList.toggle('open');
    }

    function startAutoRotate() {
        if (autoRotateInterval) clearInterval(autoRotateInterval);
        autoRotateInterval = setInterval(() => {
            if (!panorama) return;
            const pov = panorama.getPov();
            pov.heading += 0.15; 
            panorama.setPov(pov);
        }, 50);
    }

    function stopAutoRotate() {
        if (autoRotateInterval) {
            clearInterval(autoRotateInterval);
            autoRotateInterval = null;
        }
    }

    function closeFullscreen() {
        document.getElementById('fullscreen-overlay').style.display = 'none';
        stopAutoRotate();
        document.getElementById('fs-pano').innerHTML = ''; 
    }

    function setupInteractions() {
        const layers = ['trees-points', 'trees-sticks', 'trees-canopy'];
        layers.forEach(layerID => {
            map.on('mouseenter', layerID, () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', layerID, () => map.getCanvas().style.cursor = '');

            map.on('click', layerID, (e) => {
                if (!isTreeLayerOn) return;
                const p = e.features[0].properties;
                const coords = e.features[0].geometry.coordinates; 
                openFullscreen(coords[1], coords[0], p[COL.SPECIES] || 'Unknown', p[COL.DBH] || 0, p[COL.HEALTH] || 'N/A');
            });
        });

        document.getElementById('chk-parks').addEventListener('change', e => map.setLayoutProperty('custom-parks', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-water').addEventListener('change', e => map.setLayoutProperty('custom-water', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-buildings').addEventListener('change', e => {
            const visibility = e.target.checked ? 'visible' : 'none';
            if (isIsometric) {
                map.setLayoutProperty('custom-buildings', 'visibility', 'none');
                map.setLayoutProperty('custom-buildings-3d', 'visibility', visibility);
            } else {
                map.setLayoutProperty('custom-buildings', 'visibility', visibility);
                map.setLayoutProperty('custom-buildings-3d', 'visibility', 'none');
            }
        });
    }

    function handleSearchInput() {
        const searchVal = document.getElementById('species-search').value.toLowerCase();
        const chips = document.querySelectorAll('.chip');
        if (searchVal.length > 0) {
            chips.forEach(c => c.style.opacity = "0.3"); 
        } else {
            chips.forEach(c => { 
                const keyword = c.getAttribute('data-key');
                c.style.opacity = activeGenera.includes(keyword) ? "1" : "0.5";
            });
        }
        applyMapFilters();
    }

    function applyMapFilters() {
        if (!isTreeLayerOn) return;
        const searchVal = document.getElementById('species-search').value.trim();
        const filters = ['all'];
        if (currentBorough !== 'All') filters.push(['==', COL.BOROUGH, currentBorough]);
        if (searchVal.length > 0) {
            filters.push(['!=', ['index-of', searchVal.toUpperCase(), ['upcase', ['get', COL.SPECIES]]], -1]);
        } else {
            if (activeGenera.length > 0) {
                const speciesConditions = ['any'];
                activeGenera.forEach(keyword => speciesConditions.push(['in', keyword, ['get', COL.SPECIES]]));
                filters.push(speciesConditions);
            } else {
                filters.push(['==', COL.SPECIES, 'IMPOSSIBLE']);
            }
        }
        map.setFilter('trees-points', filters);
        map.setFilter('trees-sticks', filters);
        if(map.getLayer('trees-canopy')) map.setFilter('trees-canopy', filters);
    }

    function setBorough(boro, btn) {
        currentBorough = boro;
        document.querySelectorAll('.b-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyMapFilters(); 
        const locations = { 'Manhattan': [-73.97, 40.78], 'Brooklyn': [-73.95, 40.65], 'Queens': [-73.85, 40.73], 'Bronx': [-73.87, 40.85], 'Staten Island': [-74.15, 40.57] };
        if(locations[boro]) map.flyTo({ center: locations[boro], zoom: 14, pitch: isIsometric ? 60 : 0 });
        else map.flyTo({ center: [-73.97, 40.78], zoom: 11, pitch: isIsometric ? 60 : 0 });
    }

    function toggleIsometric(btn) {
        isIsometric = !isIsometric;
        btn.classList.toggle('active');
        if (isIsometric) {
            map.flyTo({ pitch: 60, bearing: -45, zoom: map.getZoom() < 13 ? 13 : map.getZoom() });
            if (document.getElementById('chk-buildings').checked) {
                map.setLayoutProperty('custom-buildings', 'visibility', 'none');
                map.setLayoutProperty('custom-buildings-3d', 'visibility', 'visible');
            }
            if (isTreeLayerOn) {
                map.setLayoutProperty('trees-points', 'visibility', 'none');
                map.setLayoutProperty('trees-sticks', 'visibility', 'visible');
                map.setLayoutProperty('trees-canopy', 'visibility', 'visible');
            }
        } else {
            map.flyTo({ pitch: 0, bearing: 0 });
            if (document.getElementById('chk-buildings').checked) {
                map.setLayoutProperty('custom-buildings', 'visibility', 'visible');
            }
            map.setLayoutProperty('custom-buildings-3d', 'visibility', 'none');
            if (isTreeLayerOn) {
                map.setLayoutProperty('trees-points', 'visibility', 'visible');
                map.setLayoutProperty('trees-sticks', 'visibility', 'none');
                map.setLayoutProperty('trees-canopy', 'visibility', 'none');
            }
        }
    }

    function toggleMasterTreeLayer() {
        isTreeLayerOn = document.getElementById('chk-trees-master').checked;
        const visibility = isTreeLayerOn ? 'visible' : 'none';
        if (isIsometric) {
            map.setLayoutProperty('trees-sticks', 'visibility', visibility);
            map.setLayoutProperty('trees-canopy', 'visibility', visibility);
        } else {
            map.setLayoutProperty('trees-points', 'visibility', visibility);
        }
        document.getElementById('tree-content').classList.toggle('collapsed', !isTreeLayerOn);
    }

    function buildChipGrid() {
        const container = document.getElementById('chip-container');
        container.innerHTML = '';
        treeCatalog.forEach(t => {
            const chip = document.createElement('div');
            chip.className = 'chip active';
            chip.setAttribute('data-key', t.keyword);
            chip.onclick = () => toggleChip(t.keyword, chip);
            let dotHTML = `<div class="chip-dot" style="background:${t.color}"></div>`;
            chip.innerHTML = dotHTML + `<span>${t.label}</span>`;
            container.appendChild(chip);
        });
    }

    function toggleChip(keyword, element) {
        document.getElementById('species-search').value = ''; 
        document.querySelectorAll('.chip').forEach(c => {
            if(activeGenera.includes(c.getAttribute('data-key'))) c.style.opacity = '1';
            else c.style.opacity = '0.5';
        });
        if (activeGenera.includes(keyword)) {
            activeGenera = activeGenera.filter(k => k !== keyword);
            element.classList.remove('active');
            element.style.opacity = "0.5";
        } else {
            activeGenera.push(keyword);
            element.classList.add('active');
            element.style.opacity = "1";
        }
        applyMapFilters();
    }

    function toggleAll(selectAll) {
        document.getElementById('species-search').value = '';
        const chips = document.querySelectorAll('.chip');
        if (selectAll) {
            activeGenera = treeCatalog.map(t => t.keyword);
            chips.forEach(c => { c.classList.add('active'); c.style.opacity = "1"; });
        } else {
            activeGenera = [];
            chips.forEach(c => { c.classList.remove('active'); c.style.opacity = "0.5"; });
        }
        applyMapFilters();
    }

    function getLeafImage(speciesName) {
        for (const [genus, url] of Object.entries(leafImages)) {
            if (speciesName.includes(genus)) return url;
        }
        return leafImages['DEFAULT'];
    }
</script>
</body>
</html>
