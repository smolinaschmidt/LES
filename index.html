<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>NYC Forestry: Zoom & Filter</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body { margin: 0; padding: 0; background-color: #f5f5f5; font-family: 'Inter', sans-serif; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; background-color: #f5f5f5; }

    /* --- TOP BAR (BOROUGHS) --- */
    #top-bar {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 8px; z-index: 20;
        background: rgba(255, 255, 255, 0.95); padding: 5px 10px; border-radius: 30px;
        backdrop-filter: blur(8px); border: 1px solid #ddd; overflow-x: auto; max-width: 95%;
        scrollbar-width: none;
    }
    #top-bar::-webkit-scrollbar { display: none; }
    
    .b-btn {
        background: transparent; border: none; color: #666;
        padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 11px; font-weight: 600;
        transition: 0.2s; white-space: nowrap;
    }
    .b-btn:hover { color: #333; background: #e8e8e8; }
    .b-btn.active { background: #00e676; color: #000; box-shadow: 0 0 12px rgba(0,230,118,0.3); }
    
    .iso-btn { background: #f0f0f0; color: #333; border: 1px solid #ccc; }
    .iso-btn:hover { background: #e8e8e8; color: #000; }
    .iso-btn.active { background: #00b0ff; color: white; border-color: #00b0ff; box-shadow: 0 0 12px rgba(0,176,255,0.4); }

    /* --- SIDEBAR --- */
    #sidebar {
        position: absolute; top: 80px; left: 20px; width: 320px; bottom: 30px;
        background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
        color: #333; padding: 0; border-radius: 12px; border: 1px solid #ddd;
        box-shadow: 0 20px 50px rgba(0,0,0,0.1); z-index: 10;
        display: flex; flex-direction: column; overflow: hidden;
    }

    .header { padding: 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
    h2 { margin: 0; font-size: 18px; font-weight: 700; color: #222; }
    p.sub { margin: 5px 0 0; font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }

    /* --- LAYERS UI --- */
    .layer-group { border-bottom: 1px solid #eee; }
    .layer-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; cursor: pointer; transition: 0.2s; }
    .layer-header:hover { background: rgba(0,0,0,0.03); }
    .layer-title { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #333; }
    .arrow { font-size: 10px; color: #999; transition: 0.3s; }
    .arrow.rotated { transform: rotate(180deg); }

    .toggle { position: relative; display: inline-block; width: 32px; height: 18px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #00e676; }
    input:checked + .slider:before { transform: translateX(14px); }

    #tree-content { display: block; padding: 0; background: #fafafa; max-height: 60vh; overflow-y: auto; border-top: 1px solid #eee; }
    #tree-content.collapsed { display: none; }

    .search-container { padding: 15px 20px 10px; position: sticky; top: 0; background: #fafafa; z-index: 5; }
    .search-input { width: 100%; box-sizing: border-box; background: white; border: 1px solid #ddd; color: #333; padding: 8px 12px; border-radius: 6px; font-family: 'Inter'; font-size: 12px; outline: none; transition: 0.2s; }
    .search-input:focus { border-color: #00e676; }

    .filter-tools { padding: 0 20px 10px; display: flex; gap: 10px; }
    .mini-btn { font-size: 10px; background: white; border: 1px solid #ddd; color: #666; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    .mini-btn:hover { background: #f0f0f0; color: #333; }

    .legend-container { padding: 0 20px 20px; }
    .chip-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: white; border: 1px solid #ddd; border-radius: 20px; font-size: 11px; color: #666; cursor: pointer; transition: all 0.2s ease; user-select: none; }
    .chip:hover { background: #f8f8f8; color: #333; transform: translateY(-1px); }
    .chip.active { background: #f0f0f0; color: #222; border-color: #999; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .chip-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    
    /* --- POPUP --- */
    .mapboxgl-popup { max-width: 360px !important; z-index: 50; }
    .mapboxgl-popup-content { background: #ffffff; color: #333; border: 1px solid #ddd; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .popup-img-header { height: 160px; background-size: cover; background-position: center; position: relative; }
    .photo-credit { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 9px; padding: 3px 8px; border-radius: 10px; backdrop-filter: blur(2px); }
    .popup-body { padding: 20px; }
    .popup-title { font-size: 22px; font-weight: 700; color: #222; font-style: italic; margin-bottom: 8px; line-height: 1.1; }
    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    .data-box { background: #f5f5f5; padding: 10px; border-radius: 6px; border: 1px solid #eee; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    .data-label { font-size: 9px; color: #999; text-transform: uppercase; font-weight: 700; }
    .data-value { font-size: 13px; font-weight: 600; color: #222; }
    .address-box { font-size: 11px; color: #666; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;}
    .leaf-specimen { display: flex; align-items: center; gap: 15px; background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 16px; }
    .leaf-img { width: 45px; height: 45px; object-fit: contain; mix-blend-mode: multiply; }
    .leaf-info span { display: block; color: #222; }
    .btn-row { display: flex; gap: 10px; }
    .btn { flex: 1; text-align: center; padding: 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; color: white; transition: 0.2s;}
    .btn-upload { background: #00e676; color: #000; }
    .btn-wiki { background: #666; }
    .mapboxgl-popup-close-button { color: #333; font-size: 24px; padding: 5px 12px; z-index: 10; }
</style>
</head>
<body>

<div id="top-bar">
    <button class="b-btn active" onclick="setBorough('All', this)">NYC All</button>
    <button class="b-btn" onclick="setBorough('Manhattan', this)">Manhattan</button>
    <button class="b-btn" onclick="setBorough('Brooklyn', this)">Brooklyn</button>
    <button class="b-btn" onclick="setBorough('Queens', this)">Queens</button>
    <button class="b-btn" onclick="setBorough('Bronx', this)">Bronx</button>
    <button class="b-btn" onclick="setBorough('Staten Island', this)">Staten Island</button>
    <button class="b-btn iso-btn" onclick="toggleIsometric(this)" style="margin-left: 10px;">üìê 3D View</button>
</div>

<div id="sidebar">
    <div class="header">
        <h2>NYC Forestry Map</h2>
        <p class="sub">Data Explorer</p>
    </div>
    
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title" onclick="toggleTreeAccordion()">
                <span class="arrow rotated" id="tree-arrow">‚ñº</span> Trees Layer
            </div>
            <label class="toggle">
                <input type="checkbox" checked id="chk-trees-master" onchange="toggleMasterTreeLayer()">
                <span class="slider"></span>
            </label>
        </div>
        <div id="tree-content">
            <div class="search-container">
                <input type="text" id="species-search" class="search-input" placeholder="Search species (e.g. Oak)..." onkeyup="filterChips()">
            </div>
            <div class="filter-tools">
                <button class="mini-btn" onclick="toggleAll(true)">Select All</button>
                <button class="mini-btn" onclick="toggleAll(false)">Clear</button>
            </div>
            <div class="legend-container">
                <div class="chip-grid" id="chip-container"></div>
            </div>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Parks Layer</div>
            <label class="toggle"><input type="checkbox" id="chk-parks" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Water Layer</div>
            <label class="toggle"><input type="checkbox" id="chk-water" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group">
        <div class="layer-header">
            <div class="layer-title">Streets Layer</div>
            <label class="toggle"><input type="checkbox" id="chk-streets" checked><span class="slider"></span></label>
        </div>
    </div>
    <div class="layer-group" style="border-bottom: none;">
        <div class="layer-header">
            <div class="layer-title">Buildings Layer</div>
            <label class="toggle"><input type="checkbox" id="chk-buildings" checked><span class="slider"></span></label>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW9saXM3MjYiLCJhIjoiY21oeHFrNGxhMDEzYzJrcHk0czJqejVlbCJ9.qLIfPy7V7FfgnEWg6CPQcA';

    const TILESET_ID = 'molis726.440hoo1z';
    const LAYER_NAME = 'Forestry_Tree_Points-81mjz0';
    const COL = { SPECIES: 'GenusSpecies', DBH: 'DBH', HEALTH: 'TPCondition', BOROUGH: 'boroname' };

    const treeCatalog = [
        { label: 'Platanus', keyword: 'Platanus', color: '#00e676' },
        { label: 'Acer (Maple)', keyword: 'Acer', color: '#ff3d00' },
        { label: 'Quercus (Oak)', keyword: 'Quercus', color: '#d50000' },
        { label: 'Gleditsia', keyword: 'Gleditsia', color: '#64dd17' },
        { label: 'Tilia (Linden)', keyword: 'Tilia', color: '#00b0ff' },
        { label: 'Pyrus (Pear)', keyword: 'Pyrus', color: '#aa00ff' },
        { label: 'Prunus (Cherry)', keyword: 'Prunus', color: '#c51162' },
        { label: 'Zelkova', keyword: 'Zelkova', color: '#2962ff' },
        { label: 'Ginkgo', keyword: 'Ginkgo', color: '#ffd600' },
        { label: 'Fraxinus (Ash)', keyword: 'Fraxinus', color: '#795548' },
        { label: 'Liquidambar', keyword: 'Liquidambar', color: '#f06292' },
        { label: 'Ulmus (Elm)', keyword: 'Ulmus', color: '#8d6e63' },
        { label: 'Styphnolobium', keyword: 'Styphnolobium', color: '#6200ea' },
        { label: 'Pinus (Pine)', keyword: 'Pinus', color: '#1b5e20' },
        { label: 'Metasequoia', keyword: 'Metasequoia', color: '#e65100' },
        { label: 'Magnolia', keyword: 'Magnolia', color: '#f48fb1' },
        { label: 'Cornus', keyword: 'Cornus', color: '#ce93d8' },
        { label: 'Liriodendron', keyword: 'Liriodendron', color: '#aeea00' },
        { label: 'Morus', keyword: 'Morus', color: '#9c27b0' },
        { label: 'Celtis', keyword: 'Celtis', color: '#afb42b' },
        { label: 'Fagus', keyword: 'Fagus', color: '#5d4037' },
        { label: 'Betula', keyword: 'Betula', color: '#ffe082' },
        { label: 'Salix', keyword: 'Salix', color: '#827717' },
        { label: 'Aesculus', keyword: 'Aesculus', color: '#ffab00' }
    ];

    const leafImages = {
        'Acer': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Acer_pseudoplatanus_leaf_2.jpg/240px-Acer_pseudoplatanus_leaf_2.jpg',
        'Quercus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Quercus_robur_leaf_01.jpg/240px-Quercus_robur_leaf_01.jpg',
        'Platanus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/Platanus_occidentalis_1.jpg/240px-Platanus_occidentalis_1.jpg',
        'Ginkgo': 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Ginkgo_biloba_Scanned_Leaf.jpg/240px-Ginkgo_biloba_Scanned_Leaf.jpg',
        'Gleditsia': 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Gleditsia_triacanthos_leaf.jpg/240px-Gleditsia_triacanthos_leaf.jpg',
        'Tilia': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Tilia_cordata_Leaf.jpg/240px-Tilia_cordata_Leaf.jpg',
        'Pinus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/Pinus_strobus_Needles_Closeup.jpg/240px-Pinus_strobus_Needles_Closeup.jpg',
        'Prunus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Prunus_avium_leaf.jpg/240px-Prunus_avium_leaf.jpg',
        'Pyrus': 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Pyrus_communis_leaf.jpg/240px-Pyrus_communis_leaf.jpg',
        'Zelkova': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Zelkova_serrata_leaf.jpg/240px-Zelkova_serrata_leaf.jpg',
        'Liquidambar': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Liquidambar_styraciflua_leaf.jpg/240px-Liquidambar_styraciflua_leaf.jpg',
        'DEFAULT': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Leaf_icon_03.svg/240px-Leaf_icon_03.svg.png'
    };

    let activeGenera = treeCatalog.map(t => t.keyword);
    let currentBorough = 'All';
    let isTreeLayerOn = true;
    let isIsometric = false;

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [-73.970, 40.782], zoom: 11, pitch: 0, bearing: 0
    });
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

    map.on('load', () => {
        // --- 1. GENERATE "STICK" ICON ---
        const canvas = document.createElement('canvas');
        canvas.width = 20; canvas.height = 80;
        const ctx = canvas.getContext('2d');
        const grd = ctx.createLinearGradient(0, 0, 20, 0);
        grd.addColorStop(0, "rgba(100,100,100,0.7)");
        grd.addColorStop(0.5, "rgba(80,80,80,1)");
        grd.addColorStop(1, "rgba(100,100,100,0.7)");
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, 20, 80);
        map.addImage('tree-stick', { width: 20, height: 80, data: ctx.getImageData(0,0,20,80).data }, { sdf: true });

        // --- 2. HIDE BASE MAP ---
        map.getStyle().layers.forEach(l => map.setLayoutProperty(l.id, 'visibility', 'none'));

        // --- 3. ADD LAYERS ---
        map.addSource('nyc-forestry', { type: 'vector', url: 'mapbox://' + TILESET_ID });
        map.addLayer({ 'id': 'custom-parks', 'type': 'fill', 'source': 'composite', 'source-layer': 'landuse', 'filter': ['==', 'class', 'park'], 'paint': { 'fill-color': '#1b5e20', 'fill-opacity': 0.3 }, 'layout': { 'visibility': 'visible' } });
        map.addLayer({ 'id': 'custom-water', 'type': 'fill', 'source': 'composite', 'source-layer': 'water', 'paint': { 'fill-color': '#01579b', 'fill-opacity': 0.4 }, 'layout': { 'visibility': 'visible' } });
        map.addLayer({ 'id': 'custom-streets', 'type': 'line', 'source': 'composite', 'source-layer': 'road', 'paint': { 'line-color': '#cccccc', 'line-width': ['interpolate', ['linear'], ['zoom'], 11, 0.5, 18, 2] }, 'layout': { 'visibility': 'visible', 'line-join': 'round', 'line-cap': 'round' } });
        map.addLayer({ 'id': 'custom-buildings', 'type': 'fill', 'source': 'composite', 'source-layer': 'building', 'paint': { 'fill-color': '#d4cfc9', 'fill-opacity': 0.7, 'fill-outline-color': '#999999' }, 'layout': { 'visibility': 'visible' } });

        const colorExpr = ['case'];
        treeCatalog.forEach(t => {
            colorExpr.push(['in', t.keyword, ['get', COL.SPECIES]]);
            colorExpr.push(t.color);
        });
        colorExpr.push('#555');

        map.addLayer({
            'id': 'trees-points',
            'type': 'circle',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'paint': {
                // Radius increases significantly at zoom 14
                'circle-radius': ['interpolate', ['linear'], ['zoom'], 11, 1.5, 14, 3, 18, 9],
                'circle-color': colorExpr,
                'circle-opacity': 0.85
            }
        });

        map.addLayer({
            'id': 'trees-sticks',
            'type': 'symbol',
            'source': 'nyc-forestry',
            'source-layer': LAYER_NAME,
            'layout': {
                'visibility': 'none',
                'icon-image': 'tree-stick',
                'icon-allow-overlap': true,
                'icon-anchor': 'bottom',
                'icon-pitch-alignment': 'viewport',
                'icon-size': ['interpolate', ['linear'], ['get', COL.DBH], 0, 0.1, 50, 1.5]
            },
            'paint': { 'icon-color': colorExpr, 'icon-opacity': 0.9 }
        });

        buildChipGrid();
        setupInteractions();
    });

    function toggleIsometric(btn) {
        isIsometric = !isIsometric;
        btn.classList.toggle('active');

        if (isIsometric) {
            map.flyTo({ pitch: 60, bearing: -45, zoom: map.getZoom() < 13 ? 13 : map.getZoom() });
            if (isTreeLayerOn) {
                map.setLayoutProperty('trees-points', 'visibility', 'none');
                map.setLayoutProperty('trees-sticks', 'visibility', 'visible');
            }
        } else {
            map.flyTo({ pitch: 0, bearing: 0 });
            if (isTreeLayerOn) {
                map.setLayoutProperty('trees-points', 'visibility', 'visible');
                map.setLayoutProperty('trees-sticks', 'visibility', 'none');
            }
        }
    }

    function toggleMasterTreeLayer() {
        const isChecked = document.getElementById('chk-trees-master').checked;
        isTreeLayerOn = isChecked;
        if (isIsometric) {
             map.setLayoutProperty('trees-sticks', 'visibility', isChecked ? 'visible' : 'none');
             map.setLayoutProperty('trees-points', 'visibility', 'none');
        } else {
             map.setLayoutProperty('trees-points', 'visibility', isChecked ? 'visible' : 'none');
             map.setLayoutProperty('trees-sticks', 'visibility', 'none');
        }
        if (!isChecked) {
            document.getElementById('tree-content').classList.add('collapsed');
            document.getElementById('tree-arrow').classList.remove('rotated');
        } else {
             document.getElementById('tree-content').classList.remove('collapsed');
             document.getElementById('tree-arrow').classList.add('rotated');
        }
    }

    function setBorough(boro, btn) {
        currentBorough = boro;
        
        // UI Update
        document.querySelectorAll('.b-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Strict Filter
        applyMapFilters(); 

        // ZOOM LOGIC: Zoom 14 ensures points are visible (radius 3px)
        const targetZoom = 14; 
        
        const locations = {
            'Manhattan': { center: [-73.97, 40.78], zoom: targetZoom },
            'Brooklyn':  { center: [-73.95, 40.65], zoom: targetZoom },
            'Queens':    { center: [-73.85, 40.73], zoom: targetZoom },
            'Bronx':     { center: [-73.87, 40.85], zoom: targetZoom },
            'Staten Island': { center: [-74.15, 40.57], zoom: targetZoom }
        };

        if(locations[boro]) {
            map.flyTo({ 
                center: locations[boro].center, 
                zoom: locations[boro].zoom, 
                pitch: isIsometric ? 60 : 0 
            });
        } else {
            // 'All' resets to high view
            map.flyTo({ 
                center: [-73.97, 40.78], 
                zoom: 11, 
                pitch: isIsometric ? 60 : 0 
            });
        }
    }

    function applyMapFilters() {
        if (!isTreeLayerOn) return; 
        const filters = ['all']; 
        if (currentBorough !== 'All') filters.push(['==', COL.BOROUGH, currentBorough]);
        
        if (activeGenera.length > 0) {
            const speciesConditions = ['any'];
            activeGenera.forEach(keyword => speciesConditions.push(['in', keyword, ['get', COL.SPECIES]]));
            filters.push(speciesConditions);
        } else {
            filters.push(['==', COL.SPECIES, 'IMPOSSIBLE']); 
        }

        map.setFilter('trees-points', filters);
        map.setFilter('trees-sticks', filters);
    }

    function filterChips() {
        const query = document.getElementById('species-search').value.toLowerCase();
        document.querySelectorAll('.chip').forEach(chip => {
            chip.style.display = chip.innerText.toLowerCase().includes(query) ? 'flex' : 'none';
        });
    }

    function buildChipGrid() {
        const container = document.getElementById('chip-container');
        container.innerHTML = '';
        treeCatalog.forEach(t => {
            const chip = document.createElement('div');
            chip.className = 'chip active';
            chip.setAttribute('data-key', t.keyword);
            chip.onclick = () => toggleChip(t.keyword, chip);
            chip.innerHTML = `<div class="chip-dot" style="background:${t.color}"></div><span>${t.label}</span>`;
            container.appendChild(chip);
        });
    }

    function toggleChip(keyword, element) {
        if (activeGenera.includes(keyword)) {
            activeGenera = activeGenera.filter(k => k !== keyword);
            element.classList.remove('active');
            element.style.opacity = "0.5";
        } else {
            activeGenera.push(keyword);
            element.classList.add('active');
            element.style.opacity = "1";
        }
        applyMapFilters();
    }

    function toggleAll(selectAll) {
        const chips = document.querySelectorAll('.chip');
        if (selectAll) {
            activeGenera = treeCatalog.map(t => t.keyword);
            chips.forEach(c => { c.classList.add('active'); c.style.opacity = "1"; });
        } else {
            activeGenera = [];
            chips.forEach(c => { c.classList.remove('active'); c.style.opacity = "0.5"; });
        }
        applyMapFilters();
    }

    function getLeafImage(speciesName) {
        for (const [genus, url] of Object.entries(leafImages)) {
            if (speciesName.includes(genus)) return url;
        }
        return leafImages['DEFAULT'];
    }

    function setupInteractions() {
        const layers = ['trees-points', 'trees-sticks'];
        
        layers.forEach(layerID => {
            map.on('mouseenter', layerID, () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', layerID, () => map.getCanvas().style.cursor = '');

            map.on('click', layerID, async (e) => {
                if (!isTreeLayerOn) return;
                const p = e.features[0].properties;
                const coords = e.features[0].geometry.coordinates;
                
                const species = p[COL.SPECIES] || 'Unknown';
                const dbh = p[COL.DBH] || 0;
                const health = p[COL.HEALTH] || 'N/A';
                const circumference = Math.round(dbh * 3.14);
                const photoUrl = `https://source.unsplash.com/600x400/?tree,${species.split(' ')[0]}`;
                const leafUrl = getLeafImage(species);

                new mapboxgl.Popup({ closeButton: true, offset: [0, -20] })
                    .setLngLat(coords)
                    .setHTML(`
                        <div class="popup-img-header" style="background-image: url('${photoUrl}')">
                            <div class="photo-credit">Photo: Community / Unsplash</div>
                        </div>
                        <div class="popup-body">
                            <div class="popup-title">${species}</div>
                            <div class="address-box"><span>üìç</span><span id="addr-real">Locating...</span></div>
                            <div class="leaf-specimen">
                                <img src="${leafUrl}" class="leaf-img">
                                <div class="leaf-info">
                                    <span style="font-size:10px; color:#888; text-transform:uppercase; font-weight:700">Foliage ID</span>
                                    <span style="font-size:14px; font-weight:600; color:#000">Specimen View</span>
                                </div>
                            </div>
                            <div class="data-grid">
                                <div class="data-box"><span class="data-label">Health</span><span class="data-value" style="color:${health.includes('Good')?'#00e676':'#ffab00'}">${health}</span></div>
                                <div class="data-box"><span class="data-label">Age</span><span class="data-value">${dbh > 0 ? '~'+Math.round(dbh*4)+'y' : '?'}</span></div>
                                <div class="data-box"><span class="data-label">Diameter</span><span class="data-value">${dbh}"</span></div>
                                <div class="data-box"><span class="data-label">Circumference</span><span class="data-value">${circumference}"</span></div>
                            </div>
                            <div class="btn-row">
                                <button class="btn btn-upload">Upload Photo</button>
                                <a href="https://en.wikipedia.org/wiki/${species.split(' ')[0]}" target="_blank" class="btn btn-wiki">Wiki</a>
                            </div>
                        </div>
                    `)
                    .addTo(map);

                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[1]}&lon=${coords[0]}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    let fullAddr = data.display_name.split(',')[0];
                    if (data.address && data.address.house_number && (data.address.road || data.address.street)) {
                        fullAddr = `${data.address.house_number} ${data.address.road || data.address.street}, ${data.address.suburb || 'NYC'}`;
                    }
                    document.getElementById('addr-real').innerText = fullAddr;
                } catch (err) {
                    document.getElementById('addr-real').innerText = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
                }
            });
        });

        document.getElementById('chk-parks').addEventListener('change', e => map.setLayoutProperty('custom-parks', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-water').addEventListener('change', e => map.setLayoutProperty('custom-water', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-streets').addEventListener('change', e => map.setLayoutProperty('custom-streets', 'visibility', e.target.checked ? 'visible' : 'none'));
        document.getElementById('chk-buildings').addEventListener('change', e => map.setLayoutProperty('custom-buildings', 'visibility', e.target.checked ? 'visible' : 'none'));
    }
</script>
</body>
</html>
